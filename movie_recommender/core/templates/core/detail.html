{% extends 'core/base.html' %}

{% block content %}
<div
    class="flex flex-col md:flex-row gap-10 bg-[#1c1917] p-8 rounded-2xl shadow-[0_20px_50px_rgba(0,0,0,0.7)] mb-12 border-4 border-[#44403c] relative overflow-hidden">
    <!-- Background Pattern -->
    <div class="absolute inset-0 opacity-10 pointer-events-none"
        style="background-image: url('https://www.transparenttextures.com/patterns/aztec.png');"></div>

    <div class="w-full md:w-1/3 lg:w-1/4 flex-shrink-0 relative z-10">
        <div
            class="rounded-lg overflow-hidden shadow-2xl aspect-[2/3] bg-[#0f291e] border-4 border-[#b45309] relative group">
            <!-- Corner Decorations -->
            <div class="absolute top-0 left-0 w-6 h-6 border-t-4 border-l-4 border-[#fbbf24] z-20"></div>
            <div class="absolute top-0 right-0 w-6 h-6 border-t-4 border-r-4 border-[#fbbf24] z-20"></div>
            <div class="absolute bottom-0 left-0 w-6 h-6 border-b-4 border-l-4 border-[#fbbf24] z-20"></div>
            <div class="absolute bottom-0 right-0 w-6 h-6 border-b-4 border-r-4 border-[#fbbf24] z-20"></div>

            <img data-tmdb-id="{{ movie.tmdb_id }}"
                src="https://via.placeholder.com/500x750?text={{ movie.title|urlencode }}" alt="{{ movie.title }}"
                class="fetch-poster w-full h-full object-cover grayscale-[20%] group-hover:grayscale-0 transition duration-700">
        </div>
    </div>

    <div class="flex-grow relative z-10">
        <h1
            class="text-4xl md:text-5xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-b from-[#fbbf24] to-[#b45309] drop-shadow-md ancient-font tracking-wide">
            {{ movie.title }}
        </h1>

        <div class="flex flex-wrap gap-4 mb-8 text-sm ancient-font tracking-wider">
            {% if movie.release_date %}
            <span
                class="bg-[#292524] px-4 py-2 rounded-full text-[#e7e5e4] border border-[#78350f] shadow-md flex items-center gap-2">
                <span>ÔøΩÔ∏è</span> {{ movie.release_date }}
            </span>
            {% endif %}
            <span
                class="bg-gradient-to-br from-[#b45309] to-[#78350f] text-[#fbbf24] px-4 py-2 rounded-full border border-[#fbbf24] shadow-lg flex items-center gap-2 font-bold">
                <span>üíé</span> {{ movie.vote_average|floatformat:1 }} / 10
            </span>
        </div>

        <h2 class="text-2xl font-bold text-[#fbbf24] mb-3 ancient-font border-b-2 border-[#b45309] inline-block pb-1">
            Chronicle</h2>
        <p
            class="text-[#d6d3d1] leading-relaxed text-lg mb-8 font-serif italic border-l-4 border-[#78350f] pl-4 py-2 bg-[#00000033] rounded-r-lg">
            {{ movie.overview }}
        </p>

        <!-- Trailer Section -->
        <div id="trailer-container" class="hidden mt-10">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-3 text-[#e7e5e4] ancient-font">
                <svg class="w-6 h-6 text-[#ef4444]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Vision of the Past
            </h2>
            <div id="trailer-wrapper"
                class="group relative aspect-w-16 aspect-h-9 bg-[#0c0a09] rounded-xl overflow-hidden shadow-[0_0_30px_rgba(180,83,9,0.3)] cursor-pointer border-4 border-[#292524] hover:border-[#b45309] transition-all">
                <!-- Thumbnail Image -->
                <img id="trailer-thumbnail"
                    class="w-full h-[400px] object-cover opacity-70 group-hover:opacity-100 transition duration-500 sepia-[30%] group-hover:sepia-0"
                    src="" alt="Trailer Thumbnail">

                <!-- Play Button Overlay -->
                <div class="absolute inset-0 flex items-center justify-center">
                    <div
                        class="bg-gradient-to-br from-[#ef4444] to-[#991b1b] rounded-full p-5 transform group-hover:scale-110 transition duration-300 shadow-[0_0_20px_rgba(239,68,68,0.6)] border-2 border-[#fca5a5]">
                        <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 20 20">
                            <path
                                d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z">
                            </path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async function () {
        const movieId = "{{ movie.tmdb_id }}";
        const apiKey = "{{ tmdb_api_key }}";
        const container = document.getElementById('trailer-container');
        const wrapper = document.getElementById('trailer-wrapper');
        const thumbnail = document.getElementById('trailer-thumbnail');

        if (!movieId || !apiKey) return;

        try {
            const response = await fetch(`https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${apiKey}`);
            const data = await response.json();

            if (data.results && data.results.length > 0) {
                // Find first YouTube Trailer
                const trailer = data.results.find(vid => vid.site === "YouTube" && vid.type === "Trailer") || data.results.find(vid => vid.site === "YouTube");

                if (trailer) {
                    // Set Thumbnail
                    thumbnail.src = `https://img.youtube.com/vi/${trailer.key}/hqdefault.jpg`;
                    container.classList.remove('hidden');

                    // Add Click Listener to Load Iframe
                    wrapper.addEventListener('click', function () {
                        wrapper.innerHTML = `<iframe class="w-full h-[400px]" src="https://www.youtube.com/embed/${trailer.key}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                    });
                }
            }
        } catch (e) {
            console.error("Error fetching trailer:", e);
        }
    });
</script>

<div class="mt-12">
    <h2
        class="text-3xl font-bold mb-8 pl-4 border-l-8 border-[#b45309] text-[#fbbf24] ancient-font uppercase tracking-widest drop-shadow-md">
        Related Artifacts
    </h2>

    {% if recommendations %}
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-8">
        {% for rec in recommendations %}
        <a href="{% url 'movie_detail' rec.movie_id %}"
            class="group block bg-[#1c1917] rounded-lg overflow-hidden shadow-lg border-2 border-[#44403c] hover:border-[#fbbf24] transform hover:-translate-y-2 transition duration-300 relative">

            <div class="relative aspect-[2/3] bg-[#0f291e]">
                <img data-tmdb-id="{{ rec.movie_id }}"
                    src="https://via.placeholder.com/500x750?text={{ rec.title|urlencode }}" alt="{{ rec.title }}"
                    class="fetch-poster w-full h-full object-cover grayscale-[50%] group-hover:grayscale-0 transition duration-500">

                <!-- Hover Overlay -->
                <div
                    class="absolute inset-0 bg-[#b45309] bg-opacity-0 group-hover:bg-opacity-20 transition flex items-center justify-center">
                    <span
                        class="opacity-0 group-hover:opacity-100 bg-[#fbbf24] text-[#78350f] font-bold px-4 py-1 rounded-full ancient-font shadow-lg transform scale-90 group-hover:scale-100 transition">Uncover</span>
                </div>
            </div>

            <div class="p-4 bg-[#1c1917] border-t border-[#44403c]">
                <h3 class="font-bold text-[#e7e5e4] text-xs leading-tight line-clamp-2 ancient-font tracking-wide group-hover:text-[#fbbf24] transition"
                    title="{{ rec.title }}">
                    {{ rec.title }}
                </h3>
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-[#a8a29e] italic font-serif border-2 border-dashed border-[#44403c] p-6 rounded-lg text-center">
        The spirits remain silent. No related artifacts found.
    </p>
    {% endif %}
</div>
{% endblock %}